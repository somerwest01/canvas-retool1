
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Canvas interactivo</title>
  <style>
    canvas {
      border: 1px solid black;
    }
  </style>
</head>
<body>
  <h2>Haz clic para dibujar l√≠neas</h2>
  
<div id="menu" style="display:none; position:absolute; background:#fff; border:1px solid #ccc; padding:10px; z-index:10;">
  <label>Tipo de objeto:</label><br>
  <select id="tipoObjeto">
    <option value="Conector">Conector</option>
    <option value="Splice">Splice</option>
    <option value="BRK">BRK</option>
  </select><br><br>
  <button onclick="confirmarTipo()">Confirmar</button>
</div>

<canvas id="drawingCanvas" width="600" height="400"></canvas>

  

<script>
  const canvas = document.getElementById('drawingCanvas');
  const ctx = canvas.getContext('2d');
  let points = [];
  let currentStart = null;
  let pendingEnd = null;

  function drawMarker(x, y, type) {
    ctx.beginPath();
    switch(type) {
      case 'Conector':
        ctx.rect(x - 5, y - 5, 10, 10);
        break;
      case 'Splice':
        ctx.moveTo(x, y - 6);
        ctx.lineTo(x - 6, y + 6);
        ctx.lineTo(x + 6, y + 6);
        ctx.closePath();
        break;
      case 'BRK':
        ctx.arc(x, y, 6, 0, 2 * Math.PI);
        ctx.fill();
        return;
    }
    ctx.stroke();
  }

  function findClosestPoint(x, y) {
    let minDist = Infinity;
    let closest = null;
    for (const p of points) {
      const dist = Math.hypot(p.x - x, p.y - y);
      if (dist < minDist) {
        minDist = dist;
        closest = p;
      }
    }
    return closest;
  }

  function confirmarTipo() {
    const tipo = document.getElementById('tipoObjeto').value;
    drawMarker(pendingEnd.x, pendingEnd.y, tipo);
    document.getElementById('menu').style.display = 'none';
    pendingEnd = null;
  }

  canvas.addEventListener('click', (e) => {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    if (!currentStart) {
      const nearest = findClosestPoint(x, y);
      if (nearest && Math.hypot(nearest.x - x, nearest.y - y) < 20) {
        currentStart = nearest;
      } else {
        currentStart = { x, y };
        points.push(currentStart);
      }
    } else {
      const endPoint = { x, y };
      points.push(endPoint);
      ctx.beginPath();
      ctx.moveTo(currentStart.x, currentStart.y);
      ctx.lineTo(endPoint.x, endPoint.y);
      ctx.stroke();

      pendingEnd = endPoint;
      const menu = document.getElementById('menu');
      menu.style.left = `${x + 10}px`;
      menu.style.top = `${y + 10}px`;
      menu.style.display = 'block';

      currentStart = null;
    }

    if (window.Retool) {
      window.Retool.modelUpdate({ points });
    }
  });
</script>


</body>
</html>
